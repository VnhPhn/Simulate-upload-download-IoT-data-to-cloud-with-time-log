<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Cloud Upload/Download Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4facfe;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.2);
        }

        .btn {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.3);
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b 0%, #ee5a52 100%);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .btn.success {
            background: linear-gradient(45deg, #51cf66 0%, #40c057 100%);
            box-shadow: 0 5px 15px rgba(81, 207, 102, 0.3);
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }

        .status.success {
            background: linear-gradient(45deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: linear-gradient(45deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: linear-gradient(45deg, #d1ecf1, #bee5eb);
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .log-section {
            grid-column: 1 / -1;
            background: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            border-radius: 15px;
            overflow: hidden;
        }

        .log-header {
            background: #333;
            padding: 15px;
            border-bottom: 1px solid #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 5px 0;
        }

        .log-entry.upload {
            color: #4facfe;
        }

        .log-entry.download {
            color: #00f2fe;
        }

        .log-entry.error {
            color: #ff6b6b;
        }

        .log-entry.success {
            color: #51cf66;
        }

        .file-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #4facfe;
        }

        .crypto-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
            font-size: 12px;
        }

        .crypto-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #4facfe;
        }

        .crypto-item strong {
            color: #333;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .crypto-info {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê IoT Cloud Simulator</h1>
            <p>Gi·∫£ l·∫≠p upload/download d·ªØ li·ªáu IoT v·ªõi b·∫£o m·∫≠t AES-GCM + RSA</p>
        </div>

        <div class="main-content">
            <div class="section">
                <h2>üì§ Upload IoT Data</h2>
                <div class="form-group">
                    <label for="sensorType">Lo·∫°i c·∫£m bi·∫øn:</label>
                    <select id="sensorType">
                        <option value="temperature">Nhi·ªát ƒë·ªô</option>
                        <option value="humidity">ƒê·ªô ·∫©m</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="sensorData">D·ªØ li·ªáu c·∫£m bi·∫øn:</label>
                    <textarea id="sensorData" rows="4" placeholder="Nh·∫≠p d·ªØ li·ªáu c·∫£m bi·∫øn ho·∫∑c t·∫°o d·ªØ li·ªáu m·∫´u..."></textarea>
                </div>
                
                <button class="btn" onclick="generateSampleData()">üé≤ T·∫°o d·ªØ li·ªáu m·∫´u</button>
                <button class="btn success" onclick="uploadData()">üì§ Upload d·ªØ li·ªáu</button>
                
                <div id="uploadStatus"></div>
                
                <div class="file-info" id="uploadInfo" style="display: none;">
                    <strong>üìÅ Th√¥ng tin file ƒë√£ upload:</strong>
                    <div id="uploadDetails"></div>
                </div>
            </div>

            <div class="section">
                <h2>üì• Download IoT Data</h2>
                <div class="form-group">
                    <label for="downloadFile">File c·∫ßn download:</label>
                    <select id="downloadFile">
                        <option value="">Ch·ªçn file ƒë·ªÉ download...</option>
                    </select>
                </div>
                
                <button class="btn" onclick="refreshFileList()">üîÑ L√†m m·ªõi danh s√°ch</button>
                <button class="btn success" onclick="downloadData()">üì• Download d·ªØ li·ªáu</button>
                
                <div id="downloadStatus"></div>
                
                <div class="file-info" id="downloadInfo" style="display: none;">
                    <strong>üìÑ N·ªôi dung file ƒë√£ download:</strong>
                    <div id="downloadContent"></div>
                </div>
            </div>

            <div class="log-section">
                <div class="log-header">
                    <h2>üìã Transaction Logs</h2>
                    <button class="btn danger" onclick="clearLogs()">üóëÔ∏è X√≥a logs</button>
                </div>
                <div class="log-content" id="logContent">
                    <div class="log-entry info">[SYSTEM] IoT Cloud Simulator ƒë√£ s·∫µn s√†ng...</div>
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>ƒêang x·ª≠ l√Ω...</p>
        </div>
    </div>

    <script>
        // Gi·∫£ l·∫≠p cloud storage
        let cloudStorage = {};
        let sessionKeys = {};
        let logEntries = [];

        // Kh·ªüi t·∫°o RSA key pair (gi·∫£ l·∫≠p)
        const RSA_KEY_SIZE = 1024;
        let clientKeyPair, serverKeyPair;

        // Kh·ªüi t·∫°o h·ªá th·ªëng
        function initializeSystem() {
            // Gi·∫£ l·∫≠p t·∫°o RSA key pairs
            clientKeyPair = generateRSAKeyPair();generateSampleData
            serverKeyPair = generateRSAKeyPair();
            
            addLog('SYSTEM', 'RSA key pairs ƒë√£ ƒë∆∞·ª£c t·∫°o (1024-bit)', 'info');
            addLog('SYSTEM', 'H·ªá th·ªëng cloud simulator s·∫µn s√†ng', 'success');
        }

        // Gi·∫£ l·∫≠p t·∫°o RSA key pair
        function generateRSAKeyPair() {
    const keySuffix = Math.random().toString(36).substr(2, 16);
    return {
        publicKey: `RSA-PUBLIC-KEY-${keySuffix}`,
        privateKey: `RSA-PRIVATE-KEY-${keySuffix}`
    };
}

        // T·∫°o d·ªØ li·ªáu m·∫´u
        function generateSampleData() {
            const sensorType = document.getElementById('sensorType').value;
            const timestamp = new Date().toISOString();
            let sampleData = '';

            switch(sensorType) {
                case 'temperature':
                    sampleData = `# Temperature Sensor Data
Timestamp: ${timestamp}
Sensor ID: TEMP_001
Location: Hanoi, Vietnam
Data:
${Array.from({length: 10}, (_, i) => 
    `${new Date(Date.now() - (9-i) * 60000).toISOString()}, ${(20 + Math.random() * 15).toFixed(2)}¬∞C`
).join('\n')}`;
                    break;
                case 'humidity':
                    sampleData = `# Humidity Sensor Data
Timestamp: ${timestamp}
Sensor ID: HUM_001
Location: Hanoi, Vietnam
Data:
${Array.from({length: 10}, (_, i) => 
    `${new Date(Date.now() - (9-i) * 60000).toISOString()}, ${(40 + Math.random() * 40).toFixed(2)}%`
).join('\n')}`;
                    break;
            }

            document.getElementById('sensorData').value = sampleData;
            addLog('SYSTEM', `ƒê√£ t·∫°o d·ªØ li·ªáu m·∫´u cho c·∫£m bi·∫øn ${sensorType}`, 'info');
        }

        // Upload d·ªØ li·ªáu
        async function uploadData() {
            const sensorType = document.getElementById('sensorType').value;
            const sensorData = document.getElementById('sensorData').value;

            if (!sensorData.trim()) {
                showStatus('uploadStatus', 'Vui l√≤ng nh·∫≠p d·ªØ li·ªáu c·∫£m bi·∫øn!', 'error');
                return;
            }

            showLoading(true);
            addLog('UPLOAD', 'B·∫Øt ƒë·∫ßu qu√° tr√¨nh upload...', 'upload');

            try {
                // 1. Handshake
                addLog('UPLOAD', 'Step 1: Handshake - G·ª≠i "Hello!" ƒë·∫øn cloud', 'upload');
                await sleep(500);
                addLog('CLOUD', 'Handshake - Nh·∫≠n "Hello!", ph·∫£n h·ªìi "Ready!"', 'success');

                // 2. X√°c th·ª±c & Trao kh√≥a
                const timestamp = new Date().toISOString();
                const filename = `sensor_data_${sensorType}_${Date.now()}.txt`;
                const metadata = {
                    filename: filename,
                    timestamp: timestamp,
                    sensorType: sensorType,
                    size: sensorData.length
                };

                addLog('UPLOAD', 'Step 2: K√Ω metadata b·∫±ng RSA/SHA-512', 'upload');
                const metadataSignature = signWithRSA(JSON.stringify(metadata), clientKeyPair.privateKey);

                // T·∫°o session key cho AES-GCM
                const sessionKey = generateAESKey();
                const encryptedSessionKey = encryptWithRSA(sessionKey, serverKeyPair.publicKey);
                
                addLog('UPLOAD', 'Step 2: M√£ h√≥a SessionKey b·∫±ng RSA-OAEP', 'upload');
                await sleep(300);

                // 3. M√£ h√≥a & Ki·ªÉm tra to√†n v·∫πn
                addLog('UPLOAD', 'Step 3: M√£ h√≥a d·ªØ li·ªáu b·∫±ng AES-GCM', 'upload');
                const nonce = generateNonce();
                const encryptionResult = encryptAESGCM(sensorData, sessionKey, nonce);
                
                const hashInput = nonce + encryptionResult.ciphertext + encryptionResult.tag;
                const hash = calculateSHA512(hashInput);
                
                addLog('UPLOAD', 'Step 3: T√≠nh hash SHA-512 ƒë·ªÉ ki·ªÉm tra to√†n v·∫πn', 'upload');
                await sleep(300);

                // T·∫°o g√≥i tin upload
                const uploadPacket = {
                    nonce: nonce,
                    cipher: encryptionResult.ciphertext,
                    tag: encryptionResult.tag,
                    hash: hash,
                    sig: metadataSignature,
                    metadata: metadata,
                    encryptedSessionKey: encryptedSessionKey
                };

                addLog('UPLOAD', 'Step 4: G·ª≠i g√≥i tin qua socket ƒë·∫øn cloud', 'upload');
                await sleep(500);

                // 4. X·ª≠ l√Ω ph√≠a cloud
                addLog('CLOUD', 'Nh·∫≠n g√≥i tin, b·∫Øt ƒë·∫ßu x√°c th·ª±c...', 'info');
                
                // Gi·∫£i m√£ session key
                const decryptedSessionKey = decryptWithRSA(uploadPacket.encryptedSessionKey, serverKeyPair.privateKey);
                
                // Ki·ªÉm tra hash
                const computedHash = calculateSHA512(uploadPacket.nonce + uploadPacket.cipher + uploadPacket.tag);
                addLog('CLOUD', `Hash nh·∫≠n ƒë∆∞·ª£c: ${uploadPacket.hash.substr(0, 20)}...`, 'info');
                addLog('CLOUD', `Hash t√≠nh to√°n: ${computedHash.substr(0, 20)}...`, 'info');
                
                 if (computedHash !== uploadPacket.hash) {
                     throw new Error('Hash kh√¥ng kh·ªõp - d·ªØ li·ªáu c√≥ th·ªÉ b·ªã thay ƒë·ªïi');
                 }
                addLog('CLOUD', '‚úì Ki·ªÉm tra hash th√†nh c√¥ng (demo mode)', 'success');
                addLog('CLOUD', '‚úì Ki·ªÉm tra hash th√†nh c√¥ng', 'success');

                // Ki·ªÉm tra ch·ªØ k√Ω
                const isValidSignature = verifyRSASignature(JSON.stringify(uploadPacket.metadata), uploadPacket.sig, clientKeyPair.publicKey);
                if (!isValidSignature) {
                    throw new Error('Ch·ªØ k√Ω kh√¥ng h·ª£p l·ªá');
                }
                addLog('CLOUD', '‚úì Ki·ªÉm tra ch·ªØ k√Ω RSA th√†nh c√¥ng', 'success');

                // Gi·∫£i m√£ d·ªØ li·ªáu
                const decryptedData = decryptAESGCM(uploadPacket.cipher, decryptedSessionKey, uploadPacket.nonce, uploadPacket.tag);
                if (!decryptedData) {
                    throw new Error('Kh√¥ng th·ªÉ gi·∫£i m√£ d·ªØ li·ªáu - tag kh√¥ng h·ª£p l·ªá');
                }
                addLog('CLOUD', '‚úì Gi·∫£i m√£ AES-GCM th√†nh c√¥ng', 'success');

                // L∆∞u v√†o cloud storage
                cloudStorage[filename] = {
                    data: decryptedData,
                    metadata: metadata,
                    uploadTime: new Date().toISOString(),
                    sessionKey: decryptedSessionKey
                };

                addLog('CLOUD', `‚úì L∆∞u file ${filename} th√†nh c√¥ng`, 'success');
                addLog('CLOUD', 'G·ª≠i ACK ƒë·∫øn client', 'success');

                // C·∫≠p nh·∫≠t giao di·ªán
                showStatus('uploadStatus', `‚úÖ Upload th√†nh c√¥ng! File: ${filename}`, 'success');
                
                document.getElementById('uploadInfo').style.display = 'block';
                document.getElementById('uploadDetails').innerHTML = `
                    <div class="crypto-info">
                        <div class="crypto-item">
                            <strong>T√™n file:</strong><br>${filename}
                        </div>
                        <div class="crypto-item">
                            <strong>Lo·∫°i c·∫£m bi·∫øn:</strong><br>${sensorType}
                        </div>
                        <div class="crypto-item">
                            <strong>K√≠ch th∆∞·ªõc:</strong><br>${sensorData.length} bytes
                        </div>
                        <div class="crypto-item">
                            <strong>Th·ªùi gian:</strong><br>${new Date().toLocaleString('vi-VN')}
                        </div>
                        <div class="crypto-item">
                            <strong>M√£ h√≥a:</strong><br>AES-GCM
                        </div>
                        <div class="crypto-item">
                            <strong>Ch·ªØ k√Ω:</strong><br>RSA/SHA-512
                        </div>
                    </div>
                `;

                refreshFileList();
                addLog('UPLOAD', `‚úÖ Upload ho√†n t·∫•t: ${filename}`, 'success');

            } catch (error) {
                addLog('ERROR', `‚ùå Upload th·∫•t b·∫°i: ${error.message}`, 'error');
                addLog('CLOUD', 'G·ª≠i NACK ƒë·∫øn client', 'error');
                showStatus('uploadStatus', `‚ùå L·ªói: ${error.message}`, 'error');
            }

            showLoading(false);
        }

        // Download d·ªØ li·ªáu
        async function downloadData() {
            const selectedFile = document.getElementById('downloadFile').value;

            if (!selectedFile) {
                showStatus('downloadStatus', 'Vui l√≤ng ch·ªçn file ƒë·ªÉ download!', 'error');
                return;
            }

            showLoading(true);
            addLog('DOWNLOAD', 'B·∫Øt ƒë·∫ßu qu√° tr√¨nh download...', 'download');

            try {
                // T·∫°o y√™u c·∫ßu download v·ªõi ch·ªØ k√Ω
                const downloadRequest = {
                    filename: selectedFile,
                    timestamp: new Date().toISOString(),
                    clientId: 'CLIENT_001'
                };

                addLog('DOWNLOAD', 'T·∫°o y√™u c·∫ßu download v·ªõi ch·ªØ k√Ω RSA/SHA-512', 'download');
                const requestSignature = signWithRSA(JSON.stringify(downloadRequest), clientKeyPair.privateKey);
                
                addLog('DOWNLOAD', 'G·ª≠i y√™u c·∫ßu download ƒë·∫øn cloud', 'download');
                await sleep(500);

                // X·ª≠ l√Ω ph√≠a cloud
                addLog('CLOUD', 'Nh·∫≠n y√™u c·∫ßu download, ki·ªÉm tra ch·ªØ k√Ω...', 'info');
                
                const isValidRequest = verifyRSASignature(JSON.stringify(downloadRequest), requestSignature, clientKeyPair.publicKey);
                if (!isValidRequest) {
                    throw new Error('X√°c th·ª±c kh√¥ng h·ª£p l·ªá - ch·ªØ k√Ω y√™u c·∫ßu kh√¥ng ƒë√∫ng');
                }
                
                addLog('CLOUD', '‚úì X√°c th·ª±c y√™u c·∫ßu th√†nh c√¥ng', 'success');

                if (!cloudStorage[selectedFile]) {
                    throw new Error('File kh√¥ng t·ªìn t·∫°i tr√™n cloud');
                }

                const fileData = cloudStorage[selectedFile];
                
                // M√£ h√≥a l·∫°i d·ªØ li·ªáu ƒë·ªÉ g·ª≠i
                const nonce = generateNonce();
                const encryptionResult = encryptAESGCM(fileData.data, fileData.sessionKey, nonce);
                const hashInput = nonce + encryptionResult.ciphertext + encryptionResult.tag;
                const hash = calculateSHA512(hashInput);
                const metadataSignature = signWithRSA(JSON.stringify(fileData.metadata), serverKeyPair.privateKey);

                const downloadPacket = {
                    nonce: nonce,
                    cipher: encryptionResult.ciphertext,
                    tag: encryptionResult.tag,
                    hash: hash,
                    sig: metadataSignature,
                    metadata: fileData.metadata
                };

                addLog('CLOUD', 'G·ª≠i g√≥i tin download ƒë·∫øn client', 'success');
                await sleep(500);

                // X·ª≠ l√Ω ph√≠a client
                addLog('DOWNLOAD', 'Nh·∫≠n g√≥i tin, b·∫Øt ƒë·∫ßu ki·ªÉm tra...', 'download');

                // Ki·ªÉm tra hash
                const computedHash = calculateSHA512(downloadPacket.nonce + downloadPacket.cipher + downloadPacket.tag);
                addLog('DOWNLOAD', `Hash nh·∫≠n ƒë∆∞·ª£c: ${downloadPacket.hash.substr(0, 20)}...`, 'info');
                addLog('DOWNLOAD', `Hash t√≠nh to√°n: ${computedHash.substr(0, 20)}...`, 'info');
                
                 if (computedHash !== downloadPacket.hash) {
                     throw new Error('Hash kh√¥ng kh·ªõp - d·ªØ li·ªáu c√≥ th·ªÉ b·ªã thay ƒë·ªïi');
                 }
                addLog('DOWNLOAD', '‚úì Ki·ªÉm tra hash th√†nh c√¥ng (demo mode)', 'success');

                // Ki·ªÉm tra ch·ªØ k√Ω metadata
                const isValidMetadata = verifyRSASignature(JSON.stringify(downloadPacket.metadata), downloadPacket.sig, serverKeyPair.publicKey);
                if (!isValidMetadata) {
                    throw new Error('Ch·ªØ k√Ω metadata kh√¥ng h·ª£p l·ªá');
                }
                addLog('DOWNLOAD', '‚úì Ki·ªÉm tra ch·ªØ k√Ω metadata th√†nh c√¥ng', 'success');

                // Gi·∫£i m√£ d·ªØ li·ªáu
                const decryptedData = decryptAESGCM(downloadPacket.cipher, fileData.sessionKey, downloadPacket.nonce, downloadPacket.tag);
                if (!decryptedData) {
                    throw new Error('Kh√¥ng th·ªÉ gi·∫£i m√£ d·ªØ li·ªáu - tag kh√¥ng h·ª£p l·ªá');
                }
                addLog('DOWNLOAD', '‚úì Gi·∫£i m√£ AES-GCM th√†nh c√¥ng', 'success');

                addLog('DOWNLOAD', 'G·ª≠i ACK ƒë·∫øn cloud', 'success');

                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                showStatus('downloadStatus', `‚úÖ Download th√†nh c√¥ng! File: ${selectedFile}`, 'success');
                
                document.getElementById('downloadInfo').style.display = 'block';
                document.getElementById('downloadContent').innerHTML = `
                    <div class="crypto-info">
                        <div class="crypto-item">
                            <strong>T√™n file:</strong><br>${selectedFile}
                        </div>
                        <div class="crypto-item">
                            <strong>K√≠ch th∆∞·ªõc:</strong><br>${decryptedData.length} bytes
                        </div>
                        <div class="crypto-item">
                            <strong>Upload l√∫c:</strong><br>${new Date(fileData.uploadTime).toLocaleString('vi-VN')}
                        </div>
                        <div class="crypto-item">
                            <strong>Download l√∫c:</strong><br>${new Date().toLocaleString('vi-VN')}
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; max-height: 200px; overflow-y: auto;">
                        <strong>üìÑ N·ªôi dung file:</strong><br>
                        <pre style="white-space: pre-wrap; font-size: 12px; margin-top: 10px;">${decryptedData}</pre>
                    </div>
                `;

                addLog('DOWNLOAD', `‚úÖ Download ho√†n t·∫•t: ${selectedFile}`, 'success');

            } catch (error) {
                addLog('ERROR', `‚ùå Download th·∫•t b·∫°i: ${error.message}`, 'error');
                addLog('CLOUD', 'G·ª≠i NACK ƒë·∫øn client', 'error');
                showStatus('downloadStatus', `‚ùå L·ªói: ${error.message}`, 'error');
            }

            showLoading(false);
        }

        // L√†m m·ªõi danh s√°ch file
        function refreshFileList() {
            const select = document.getElementById('downloadFile');
            select.innerHTML = '<option value="">Ch·ªçn file ƒë·ªÉ download...</option>';
            
            Object.keys(cloudStorage).forEach(filename => {
                const option = document.createElement('option');
                option.value = filename;
                option.textContent = `${filename} (${new Date(cloudStorage[filename].uploadTime).toLocaleString('vi-VN')})`;
                select.appendChild(option);
            });

            addLog('SYSTEM', `Danh s√°ch file ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t (${Object.keys(cloudStorage).length} files)`, 'info');
        }

        // C√°c h√†m m√£ h√≥a gi·∫£ l·∫≠p
        function generateAESKey() {
            return 'AES-KEY-' + Array.from({length: 32}, () => Math.floor(Math.random() * 16).toString(16)).join('');
        }

        function generateNonce() {
            return 'NONCE-' + Array.from({length: 12}, () => Math.floor(Math.random() * 16).toString(16)).join('');
        }

        function encryptAESGCM(plaintext, key, nonce) {
            // Gi·∫£ l·∫≠p m√£ h√≥a AES-GCM
            const ciphertext = 'CIPHER-' + btoa(plaintext).replace(/[^a-zA-Z0-9]/g, '');
            const tag = 'TAG-' + Array.from({length: 16}, () => Math.floor(Math.random() * 16).toString(16)).join('');
            return { ciphertext, tag };
        }

        function decryptAESGCM(ciphertext, key, nonce, tag) {
            // Gi·∫£ l·∫≠p gi·∫£i m√£ AES-GCM
            try {
                if (!ciphertext.startsWith('CIPHER-')) return null;
                const encoded = ciphertext.replace('CIPHER-', '');
                return atob(encoded);
            } catch (e) {
                return null;
            }
        }

        function encryptWithRSA(data, publicKey) {
            return 'RSA-ENC-' + btoa(data).replace(/[^a-zA-Z0-9]/g, '');
        }

        function decryptWithRSA(encryptedData, privateKey) {
            try {
                if (!encryptedData.startsWith('RSA-ENC-')) return null;
                const encoded = encryptedData.replace('RSA-ENC-', '');
                return atob(encoded);
            } catch (e) {
                return null;
            }
        }

        function signWithRSA(data, privateKey) {
            return 'RSA-SIG-' + calculateSHA512(data + privateKey).substr(0, 32);
        }

       function verifyRSASignature(data, signature, publicKey) {
    const keySuffix = publicKey.replace('RSA-PUBLIC-KEY-', '');
    const expectedSig = 'RSA-SIG-' + calculateSHA512(data + 'RSA-PRIVATE-KEY-' + keySuffix).substr(0, 32);
    return signature === expectedSig;
}

        function calculateSHA512(input) {
            // Gi·∫£ l·∫≠p SHA-512 hash - deterministic ƒë·ªÉ tr√°nh l·ªói validation
            let hash = 0;
            for (let i = 0; i < input.length; i++) {
                const char = input.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            // S·ª≠ d·ª•ng seed c·ªë ƒë·ªãnh ƒë·ªÉ hash nh·∫•t qu√°n
            const seed = Math.abs(hash).toString(16).padStart(16, '0');
            return 'SHA512-' + seed + '0'.repeat(48);
        }

        // Utility functions
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        function addLog(type, message, category = 'info') {
            const timestamp = new Date().toLocaleString('vi-VN');
            const logEntry = `[${timestamp}] [${type}] ${message}`;
            logEntries.push({ timestamp, type, message, category });
            
            const logContent = document.getElementById('logContent');
            const logDiv = document.createElement('div');
            logDiv.className = `log-entry ${category}`;
            logDiv.textContent = logEntry;
            logContent.appendChild(logDiv);
            logContent.scrollTop = logContent.scrollHeight;
        }

        function clearLogs() {
            logEntries = [];
            document.getElementById('logContent').innerHTML = '<div class="log-entry info">[SYSTEM] Logs ƒë√£ ƒë∆∞·ª£c x√≥a...</div>';
        }

        // Kh·ªüi t·∫°o h·ªá th·ªëng khi trang load
        window.addEventListener('load', function() {
            initializeSystem();
            
            // Demo data cho presentation
            setTimeout(() => {
                addLog('SYSTEM', 'H·ªá th·ªëng s·∫µn s√†ng nh·∫≠n d·ªØ li·ªáu IoT', 'success');
                addLog('INFO', 'S·ª≠ d·ª•ng m√£ h√≥a AES-GCM 256-bit', 'info');
                addLog('INFO', 'Ch·ªØ k√Ω s·ªë RSA 1024-bit v·ªõi SHA-512', 'info');
                addLog('INFO', 'Giao th·ª©c truy·ªÅn: TCP Socket simulation', 'info');
            }, 1000);
        });

        // Easter egg - double click on header to show crypto details
        document.querySelector('.header h1').addEventListener('dblclick', function() {
            addLog('DEBUG', 'üîê Crypto Debug Mode Activated', 'info');
            addLog('DEBUG', `Client RSA Public: ${clientKeyPair.publicKey.substr(0, 32)}...`, 'info');
            addLog('DEBUG', `Server RSA Public: ${serverKeyPair.publicKey.substr(0, 32)}...`, 'info');
            addLog('DEBUG', 'AES-GCM: 256-bit keys, 96-bit nonces, 128-bit tags', 'info');
            addLog('DEBUG', 'RSA-OAEP: SHA-256 hash, MGF1 mask generation', 'info');
        });

        // Add some visual effects
        function addRippleEffect(e) {
            const button = e.currentTarget;
            const ripple = document.createElement('span');
            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = e.clientX - rect.left - size / 2;
            const y = e.clientY - rect.top - size / 2;
            
            ripple.style.cssText = `
                position: absolute;
                width: ${size}px;
                height: ${size}px;
                left: ${x}px;
                top: ${y}px;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                transform: scale(0);
                animation: ripple 0.6s ease-out;
                pointer-events: none;
            `;
            
            button.style.position = 'relative';
            button.style.overflow = 'hidden';
            button.appendChild(ripple);
            
            setTimeout(() => ripple.remove(), 600);
        }

        // Add ripple effect to all buttons
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.textContent = `
                @keyframes ripple {
                    to {
                        transform: scale(2);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
            
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', addRippleEffect);
            });
        });

        // Auto-refresh file list every 30 seconds
        setInterval(() => {
            if (Object.keys(cloudStorage).length > 0) {
                refreshFileList();
            }
        }, 30000);

        // Simulate network latency for more realistic experience
        function simulateNetworkLatency() {
            return Math.random() * 200 + 100; // 100-300ms
        }

        // Enhanced error handling with specific error codes
        const ERROR_CODES = {
            HANDSHAKE_FAILED: 'ERR_001',
            INVALID_SIGNATURE: 'ERR_002',
            DECRYPTION_FAILED: 'ERR_003',
            HASH_MISMATCH: 'ERR_004',
            FILE_NOT_FOUND: 'ERR_005',
            AUTHENTICATION_FAILED: 'ERR_006',
            NETWORK_TIMEOUT: 'ERR_007'
        };

        // Add performance monitoring
        let performanceMetrics = {
            uploadCount: 0,
            downloadCount: 0,
            totalUploadTime: 0,
            totalDownloadTime: 0,
            errorCount: 0
        };

        function updatePerformanceMetrics(operation, duration, success = true) {
            if (operation === 'upload') {
                performanceMetrics.uploadCount++;
                performanceMetrics.totalUploadTime += duration;
            } else if (operation === 'download') {
                performanceMetrics.downloadCount++;
                performanceMetrics.totalDownloadTime += duration;
            }
            
            if (!success) {
                performanceMetrics.errorCount++;
            }
        }

        // Show performance stats on triple click
        document.querySelector('.header p').addEventListener('click', function(e) {
            if (e.detail === 3) {
                const avgUpload = performanceMetrics.uploadCount > 0 ? 
                    (performanceMetrics.totalUploadTime / performanceMetrics.uploadCount).toFixed(2) : 0;
                const avgDownload = performanceMetrics.downloadCount > 0 ? 
                    (performanceMetrics.totalDownloadTime / performanceMetrics.downloadCount).toFixed(2) : 0;
                
                addLog('STATS', `üìä Performance Metrics:`, 'info');
                addLog('STATS', `Uploads: ${performanceMetrics.uploadCount}, Avg: ${avgUpload}ms`, 'info');
                addLog('STATS', `Downloads: ${performanceMetrics.downloadCount}, Avg: ${avgDownload}ms`, 'info');
                addLog('STATS', `Errors: ${performanceMetrics.errorCount}`, 'info');
                addLog('STATS', `Files in storage: ${Object.keys(cloudStorage).length}`, 'info');
            }
        });
    </script>
</body>
</html>